<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Car demo</title>
    <script>
var Math2={IsValid:function(a){return isFinite(a)},Dot:function(a,b){return a.x*b.x+a.y*b.y},CrossVV:function(a,b){return a.x*b.y-a.y*b.x},CrossVF:function(a,b){return new Vec2(b*a.y,-b*a.x)},CrossFV:function(a,b){return new Vec2(-a*b.y,a*b.x)},MulMV:function(a,b){return new Vec2(a.col1.x*b.x+a.col2.x*b.y,a.col1.y*b.x+a.col2.y*b.y)},MulTMV:function(a,b){return new Vec2(Math2.Dot(b,a.col1),Math2.Dot(b,a.col2))},AddVV:function(a,b){return new Vec2(a.x+b.x,a.y+b.y)},SubtractVV:function(a,b){return new Vec2(a.x-
b.x,a.y-b.y)},MulFV:function(a,b){return new Vec2(a*b.x,a*b.y)},AddMM:function(a,b){return new Mat22(0,Math2.AddVV(a.col1,b.col1),Math2.AddVV(a.col2,b.col2))},MulMM:function(a,b){return new Mat22(0,Math2.MulMV(a,b.col1),Math2.MulMV(a,b.col2))},MulTMM:function(a,b){var c=new Vec2(Math2.Dot(a.col1,b.col1),Math2.Dot(a.col2,b.col1)),e=new Vec2(Math2.Dot(a.col1,b.col2),Math2.Dot(a.col2,b.col2));return new Mat22(0,c,e)},Abs:function(a){return a>0?a:-a},AbsV:function(a){return new Vec2(Math2.Abs(a.x),Math2.Abs(a.y))},
AbsM:function(a){return new Mat22(0,Math2.AbsV(a.col1),Math2.AbsV(a.col2))},Min:function(a,b){return a<b?a:b},MinV:function(a,b){return new Vec2(Math2.Min(a.x,b.x),Math2.Min(a.y,b.y))},Max:function(a,b){return a>b?a:b},MaxV:function(a,b){return new Vec2(Math2.Max(a.x,b.x),Math2.Max(a.y,b.y))}};Math2.Clamp=function(a,b,c){return Math2.Max(b,Math2.Min(a,c))};Math2.ClampV=function(a,b,c){return Math2.MaxV(b,Math2.MinV(a,c))};Math2.Swap=function(a,b){var c=a[0];a[0]=b[0];b[0]=c};
Math2.Sign=function(a){return a<0?-1:a>0?1:0};Math2.Random=function(){return Math.random()*2-1};Math2.NextPowerOfTwo=function(a){a|=a>>1&2147483647;a|=a>>2&1073741823;a|=a>>4&268435455;a|=a>>8&16777215;a|=a>>16&65535;return a+1};Math2.IsPowerOfTwo=function(a){return a>0&&(a&a-1)==0};Mat22=function(a,b,c){a==null&&(a=0);this.col1=new Vec2;this.col2=new Vec2;b!=null&&c!=null?(this.col1.SetV(b),this.col2.SetV(c)):(b=Math.cos(a),a=Math.sin(a),this.col1.x=b,this.col2.x=-a,this.col1.y=a,this.col2.y=b)};
Mat22.prototype.Set=function(a){var b=Math.cos(a),a=Math.sin(a);this.col1.x=b;this.col2.x=-a;this.col1.y=a;this.col2.y=b};Mat22.prototype.SetVV=function(a,b){this.col1.SetV(a);this.col2.SetV(b)};Mat22.prototype.Copy=function(){return new Mat22(0,this.col1,this.col2)};Mat22.prototype.SetM=function(a){this.col1.SetV(a.col1);this.col2.SetV(a.col2)};Mat22.prototype.AddM=function(a){this.col1.x+=a.col1.x;this.col1.y+=a.col1.y;this.col2.x+=a.col2.x;this.col2.y+=a.col2.y};
Mat22.prototype.SetIdentity=function(){this.col1.x=1;this.col2.x=0;this.col1.y=0;this.col2.y=1};Mat22.prototype.SetZero=function(){this.col1.x=0;this.col2.x=0;this.col1.y=0;this.col2.y=0};Mat22.prototype.Invert=function(a){var b=this.col1.x,c=this.col2.x,e=this.col1.y,d=this.col2.y,h;h=1/(b*d-c*e);a.col1.x=h*d;a.col2.x=-h*c;a.col1.y=-h*e;a.col2.y=h*b;return a};
Mat22.prototype.Solve=function(a,b,c){var e=this.col1.x,d=this.col2.x,h=this.col1.y,i=this.col2.y,g;g=1/(e*i-d*h);a.x=g*(i*b-d*c);a.y=g*(e*c-h*b);return a};Mat22.prototype.Abs=function(){this.col1.Abs();this.col2.Abs()};function Vec2(a,b){a===void 0&&(a=0);this.x=a;b===void 0&&(b=0);this.y=b}Vec2.prototype.SetZero=function(){this.y=this.x=0};Vec2.prototype.Set=function(a,b){this.x=a;this.y=b};Vec2.prototype.SetV=function(a){this.x=a.x;this.y=a.y};
Vec2.prototype.Negative=function(){return new Vec2(-this.x,-this.y)};Vec2.prototype.Copy=function(){return new Vec2(this.x,this.y)};Vec2.prototype.MulM=function(a){var b=this.x;this.x=a.col1.x*b+a.col2.x*this.y;this.y=a.col1.y*b+a.col2.y*this.y};Vec2.prototype.MulTM=function(a){var b=Vec2.dot(this,a.col1);this.y=Vec2.dot(this,a.col2);this.x=b};Vec2.prototype.AddV=function(a){this.x+=a.x;this.y+=a.y;return this};Vec2.prototype.MulS=function(a){this.x*=a;this.y*=a;return this};
Vec2.prototype.CrossVF=function(a){var b=this.x;this.x=a*this.y;this.y=-a*b};Vec2.prototype.CrossFV=function(a){var b=this.x;this.x=-a*this.y;this.y=a*b};Vec2.prototype.MinV=function(a){this.x=this.x<a.x?this.x:a.x;this.y=this.y<a.y?this.y:a.y};Vec2.prototype.MaxV=function(a){this.x=this.x>a.x?this.x:a.x;this.y=this.y>a.y?this.y:a.y};Vec2.prototype.Abs=function(){this.x=Math.abs(this.x);this.y=Math.abs(this.y)};Vec2.prototype.Length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};
Vec2.prototype.Normalize=function(){var a=this.Length();if(a<Number.MIN_VALUE)return 0;var b=1/a;this.x*=b;this.y*=b;return a};Vec2.prototype.IsValid=function(){return isFinite(this.x)&&isFinite(this.y)};Vec2.dot=function(a,b){return a.x*b.x+a.y*b.y};Vec2.cross=function(a,b){return a.x*b.y-a.y*b.x};Vec2.crossScalar=function(a,b){return new Vec2(-a*b.y,a*b.x)};Vec2.add=function(a,b){return new Vec2(a.x+b.x,a.y+b.y)};Vec2.subtract=function(a,b){return new Vec2(a.x-b.x,a.y-b.y)};
Vec2.multiplyScalar=function(a,b){return new Vec2(a*b.x,a*b.y)};Vec2.abs=function(a){return new Vec2(Math.abs(a.x),Math.abs(a.y))};Trans2=function(a,b,c){b==null&&(b=0);this.pos=new Vec2;this.m_r=new Mat22;a!=null&&this.pos.SetV(a);c!=null?this.m_r.SetM(c):this.m_r.Set(b)};Trans2.prototype.SetT=function(a){this.pos.SetV(a.pos);this.m_r.SetM(a.m_r)};Trans2.prototype.TransFromV=function(a){return Vec2.add(this.pos,Math2.MulMV(this.m_r,a))};
Trans2.prototype.TransToV=function(a){return Math2.MulTMV(this.m_r,Vec2.subtract(a,this.pos))};Trans2.prototype.TransFromM=function(a){return Math2.MulMM(this.m_r,a)};Trans2.prototype.TransFromT=function(a){var b=this.TransFromV(a.pos),a=this.TransFromM(a.m_r);return new Trans2(b,0,a)};
var key_code={BACKSPACE:8,TAB:9,RETURN:13,SHIFT:16,CTRL:17,ALT:18,ESC:27,SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46,HOME:36,END:35,PAGEUP:33,PAGEDOWN:34,INSERT:45,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBSTRACT:109,
DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123},Phys={g:9.8},Debug={enable:!0,output:function(a){if(this.enable)document.getElementById("debug").innerHTML=a},write_line:function(a){this.enable&&(document.getElementById("debug").innerHTML+=a+"<br/>")},clear:function(){this.output("")}};
function ContextEx(a,b,c){this.m_ctx=a;this.m_width=b;this.m_height=c;this.m_camera={x:0,y:0,z:50,FOV:0.5};this.m_zoom=1;this.m_trans=new Trans2({x:0,y:0},0,null)}ContextEx.prototype.set_trans=function(a){this.m_trans.SetT(a)};ContextEx.prototype.run=function(){this.m_zoom=this.m_width/(this.m_camera.z*this.m_camera.FOV)};ContextEx.prototype.world2screen=function(a){a={x:a.x-this.m_camera.x,y:a.y-this.m_camera.y};a.x*=this.m_zoom;a.y*=-this.m_zoom;a.x+=this.m_width*0.5;a.y+=this.m_height*0.5;return a};
ContextEx.prototype.screen2world=function(a){a={x:a.x-this.m_width*0.5,y:a.y-this.m_height*0.5};a.x/=this.m_zoom;a.y/=-this.m_zoom;a.x+=this.m_camera.x;a.y+=this.m_camera.y;return a};
ContextEx.prototype.draw_poly=function(a,b,c){this.m_ctx.beginPath();var e=this.m_trans.TransFromV(a[0]),e=this.world2screen(e);this.m_ctx.moveTo(e.x+0.5,e.y+0.5);for(var d=1;d<a.length;++d)e=this.m_trans.TransFromV(a[d]),e=this.world2screen(e),this.m_ctx.lineTo(e.x+0.5,e.y+0.5);if(b!=null)this.m_ctx.strokeStyle=b,this.m_ctx.stroke();if(c!=null)this.m_ctx.fillStyle=c,this.m_ctx.fill()};
ContextEx.prototype.draw_circle=function(a,b,c,e){this.m_ctx.beginPath();a=this.world2screen(this.m_trans.TransFromV(a));this.m_ctx.arc(a.x+0.5,a.y+0.5,b*this.m_zoom,0,2*Math.PI,!1);if(c!=null)this.m_ctx.strokeStyle=c,this.m_ctx.stroke();if(e!=null)this.m_ctx.fillStyle=e,this.m_ctx.fill()};
ContextEx.prototype.draw_grid=function(){this.m_ctx.fillStyle="#FFFFFF";this.m_ctx.fillRect(0,0,this.m_width,this.m_height);var a={x:0,y:0},a=this.screen2world(a),b={x:this.m_width,y:this.m_height},b=this.screen2world(b);this.m_ctx.lineWidth=1;grid_color=function(a){return a==0?"#000000":a%1E3==0?"#606060":a%100==0?"#909090":a%10==0?"#C0C0C0":"#F0F0F0"};for(var c=this.m_zoom<15?5:1,e=Math.round(a.x/c)*c;e<b.x;e+=c){var d=this.world2screen({x:e,y:0});this.m_ctx.beginPath();this.m_ctx.strokeStyle=grid_color(e);
this.m_ctx.moveTo(d.x+0.5,0);this.m_ctx.lineTo(d.x+0.5,this.m_height);this.m_ctx.stroke()}for(b=Math.round(b.y/c)*c;b<a.y;b+=c)d=this.world2screen({x:0,y:b}),this.m_ctx.beginPath(),this.m_ctx.strokeStyle=grid_color(b),this.m_ctx.moveTo(0,d.y+0.5),this.m_ctx.lineTo(this.m_width,d.y+0.5),this.m_ctx.stroke();d=this.world2screen({x:0,y:0});this.m_ctx.beginPath();this.m_ctx.lineWidth=1;this.m_ctx.strokeStyle="#000000";this.m_ctx.arc(d.x+0.5,d.y+0.5,0.5*this.m_zoom,0,2*Math.PI,!1);this.m_ctx.stroke()};
function GameObject(){this.pos=new Vec2(0,0);this.flags=this.angle=this.z=0;this.engine=null}GameObject.DRAWABLE=1;GameObject.RUNABLE=2;GameObject.MOVABLE=4;GameObject.prototype.init=function(a,b,c){this.engine=a;this.pos.SetV(b);this.angle=c};GameObject.prototype.run=function(){};GameObject.prototype.draw=function(){};function ControllableObject(){this.strafe=this.steering=this.traction=0;this.hand_brake=!1;this.flags=GameObject.DRAWABLE|GameObject.RUNABLE|GameObject.MOVABLE}
ControllableObject.prototype=new GameObject;ControllableObject.prototype.run=function(){};ControllableObject.prototype.draw=function(){};function SimpleCar(){this.path=this.steer_angle=this.speed=0;this.friction=1;this.buget=this.friction*Phys.g;this.c_drag=1;this.c_turb=30;this.resistance=0.001;this.power=100;this.max_speed1=this.power/this.buget;this.max_steer=Math.PI/4;this.back_wheels=1.2;this.front_wheels=1.5;this.wheel_base=this.back_wheels+this.front_wheels}SimpleCar.prototype=new ControllableObject;
SimpleCar.prototype.run=function(a){var b=0;this.hand_brake?b=this.speed<0?this.buget:this.speed>0?-this.buget:0:(b=this.traction*this.buget,b*this.speed>0&&Math.abs(this.speed)>this.max_speed1&&(b/=Math.abs(this.speed)/this.max_speed1));b-=(Math.abs(this.speed)*this.c_drag+this.c_turb)*this.speed*this.resistance;this.hand_brake&&Math.abs(b*a)>Math.abs(this.speed)?this.speed=0:this.speed+=b*a;Debug.write_line("<br/>Speed: "+Math.round(this.speed*3.6)+"km/h");b=this.max_steer;if(this.speed>1.0E-4||
this.speed<-1.0E-4){var c=Math.atan(this.wheel_base/(this.speed*this.speed/this.buget));c<b&&(b=c)}this.steer_angle=this.steering*b;var c=Math.cos(this.angle),e=Math.sin(this.angle),c=new Vec2(-e,c),c=Vec2.multiplyScalar(this.speed*a,c);this.pos=Vec2.add(this.pos,c);this.path+=Math.abs(this.speed*a);Debug.write_line("Path: "+Math.round(this.path)+"m");this.hand_brake||(this.angle+=b*a*this.steering*this.speed/2.7)};
SimpleCar.prototype.draw=function(){var a=[{x:-0.9,y:-2},{x:0.9,y:-2},{x:0.9,y:2},{x:0,y:2.2},{x:-0.9,y:2},{x:-0.9,y:-2}],b=[{x:-0.12,y:-0.3},{x:0.12,y:-0.3},{x:0.12,y:0.3},{x:-0.12,y:0.3},{x:-0.12,y:-0.3}],c=new Trans2(this.pos,this.angle,null);this.engine.m_ctx_ex.set_trans(c);this.engine.m_ctx_ex.m_trans.pos=Vec2.add(this.engine.m_ctx_ex.m_trans.pos,{x:0.3,y:-0.3});this.engine.m_ctx_ex.draw_poly(a,null,"rgba(0,0,0,0.5)");var e=new Trans2({x:0.85,y:this.front_wheels},this.steer_angle);this.engine.m_ctx_ex.set_trans(c.TransFromT(e));
this.engine.m_ctx_ex.draw_poly(b,null,"#404040");e.pos.x=-e.pos.x;this.engine.m_ctx_ex.set_trans(c.TransFromT(e));this.engine.m_ctx_ex.draw_poly(b,null,"#404040");e.m_r.Set(0);e.pos.x=0.85;e.pos.y=-this.back_wheels;this.engine.m_ctx_ex.set_trans(c.TransFromT(e));this.engine.m_ctx_ex.draw_poly(b,null,"#404040");e.pos.x=-e.pos.x;this.engine.m_ctx_ex.set_trans(c.TransFromT(e));this.engine.m_ctx_ex.draw_poly(b,null,"#404040");this.engine.m_ctx_ex.set_trans(c);this.engine.m_ctx_ex.draw_poly(a,"#808080",
"white");this.engine.m_ctx_ex.draw_poly([{x:0,y:1.2},{x:-0.8,y:1},{x:-0.8,y:0},{x:0.8,y:0},{x:0.8,y:1},{x:0,y:1.2},{x:0,y:2}],"#808080",null);this.engine.m_ctx_ex.draw_poly([{x:-0.7,y:0},{x:-0.7,y:-1.9},{x:0.7,y:-1.9},{x:0.7,y:0}],"#808080",null)};function CarWheel(a,b,c,e){this.car=a;this.pos=b.Copy();this.drive=c;this.steer=e;this.angle=0;this.blocked=this.sliding=!1;this.buget=0;this.old_force=new Vec2;this.sliding_coef=0.5;this.trail=[]}
CarWheel.prototype.calc_force=function(a,b,c,e){var d=this.pos.Copy();d.CrossFV(1);if((this.blocked=Math.abs(b)>this.buget)&&!this.car.hand_brake&&this.car.abs)b=this.buget,this.blocked=!1;if(this.blocked)a=c.Copy(),a.Normalize(),a=Vec2.dot(d,a),d=Vec2.multiplyScalar(1/(1/this.car.mass+a*a/this.car.inertia),c),e=Vec2.multiplyScalar(-1/e/2,d);else{var h=new Mat22(this.angle),i=h.col1,d=Vec2.dot(d,i),d=-Vec2.dot(i,c)/(1/this.car.mass+d*d/this.car.inertia),e=Vec2.multiplyScalar(d/e/2,i);this.drive&&
(Math.abs(a)>this.buget&&this.car.tcs&&(a=this.buget*Math2.Sign(a)),e.AddV(Vec2.multiplyScalar(a,h.col2)));Vec2.dot(c,h.col2)>0?e.AddV(Vec2.multiplyScalar(-b,h.col2)):e.AddV(Vec2.multiplyScalar(b,h.col2))}c=e.Length();(this.sliding=c>this.buget)&&(c>3*this.buget?e.MulS(this.sliding_coef*this.buget/c):e.MulS((1-(1-this.sliding_coef)*((c-this.buget)/(2*this.buget)))*this.buget/c));this.old_force.SetV(e);return e};
function ArcadeCar(){this.steer_angle=0;this.velocity=new Vec2(0,0);this.angular_vel=0;this.prev_accel=new Vec2(0,0);this.speed=0;this.trans=new Trans2(this.pos,this.angle,null);this.steer_control=this.tcs=this.abs=!0;this.mass=1E3;this.inertia=this.mass/12*20;this.friction=1;this.buget=this.friction*Phys.g*this.mass;this.braking_coef=2;this.front_braking=0.3;this.c_sqr=0.5;this.c_lin=this.c_sqr*30;this.power=1E5;this.max_steer=Math.PI/4;this.mass_height=0.5;this.back_wheels=1.2;this.front_wheels=
1.5;this.wheel_base=this.back_wheels+this.front_wheels;this.wheel_shift=0.85;this.trails_len=300;this.wheels=[];this.wheels[0]=[];this.wheels[0][0]=new CarWheel(this,new Vec2(-this.wheel_shift,this.front_wheels),!1,!0);this.wheels[0][1]=new CarWheel(this,new Vec2(this.wheel_shift,this.front_wheels),!1,!0);this.wheels[1]=[];this.wheels[1][0]=new CarWheel(this,new Vec2(-this.wheel_shift,-this.back_wheels),!0,!1);this.wheels[1][1]=new CarWheel(this,new Vec2(this.wheel_shift,-this.back_wheels),!0,!1)}
ArcadeCar.prototype=new ControllableObject;ArcadeCar.prototype.set_drive=function(a,b){this.wheels[0][0].drive=a;this.wheels[0][1].drive=a;this.wheels[1][0].drive=b;this.wheels[1][1].drive=b};
ArcadeCar.prototype.run=function(a){if(!(a<0.001)){var b=new Vec2,c=0,e=0,d=0,h=[0,0],i=this.velocity.Copy();i.MulTM(this.trans.m_r);d=i.y;(this.traction>0||d*this.traction>=0)&&!this.hand_brake?(e=Math.abs(d),e=e>1?this.power/e:this.power,e*=this.traction):(d=this.hand_brake?1*this.buget*this.braking_coef:Math.abs(this.traction)*this.buget*this.braking_coef,h[0]=this.front_braking*d,h[1]=(1-this.front_braking)*d);var g=this.prev_accel.Copy();g.MulTM(this.trans.m_r);var f=[];f[0]=this.mass/this.wheel_base*
(this.back_wheels*Phys.g-this.mass_height*g.y);f[1]=this.mass/this.wheel_base*(this.front_wheels*Phys.g+this.mass_height*g.y);for(var j=0,d=0;d<this.wheels.length;++d)this.wheels[d][0].drive&&++j,this.wheels[d][0].buget=(this.wheel_shift*f[d]+this.mass_height*g.x*this.mass)/(this.wheel_shift*2),this.wheels[d][1].buget=(this.wheel_shift*f[d]-this.mass_height*g.x*this.mass)/(this.wheel_shift*2);e/=j*2;d=this.max_steer;if(this.steer_control&&(d=Math.abs(Math.atan2(i.x,i.y))/0.9,this.speed>1.0E-4||this.speed<
-1.0E-4?(g=Math.atan(this.wheel_base/(this.speed*this.speed/this.buget*this.mass)),g>d&&(d=g*0.9)):d=this.max_steer,d>this.max_steer))d=this.max_steer;this.steer_angle=this.steering*d;for(d=0;d<this.wheels.length;++d)for(g=0;g<this.wheels[d].length;++g){f=this.wheels[d][g];if(f.buget<0)f.buget=0;if(f.steer)f.angle=f.pos.y>0?this.steer_angle:-this.steer_angle;wheel_vel=i.Copy();wheel_vel.AddV(Vec2.crossScalar(this.angular_vel,f.pos));j=f.calc_force(e,h[d]/2,wheel_vel,a);c+=Vec2.cross(f.pos,j);j.MulM(this.trans.m_r);
b.AddV(j)}b.AddV(Vec2.multiplyScalar(-(this.velocity.Length()*this.c_sqr+this.c_lin),this.velocity));b.MulS(1/this.mass);this.prev_accel.SetV(b);this.velocity.AddV(b.MulS(a));this.speed=this.velocity.Length();Debug.write_line("<br/>Speed: "+Math.round(this.speed*3.6)+"km/h");this.pos.AddV(Vec2.multiplyScalar(a,this.velocity));c*=a/this.inertia;this.angular_vel+=c;this.angle+=this.angular_vel*a;this.trans=new Trans2(this.pos,this.angle,null);for(d=0;d<this.wheels.length;++d)for(g=0;g<this.wheels[d].length;++g)if(f=
this.wheels[d][g],a=this.trans.TransFromV(f.pos),f.trail.push({p:a,w:f.sliding?f.buget:0}),f.trail.length>2*this.trails_len)f.trail=f.trail.slice(this.trails_len,f.trail.length-1)}};
ArcadeCar.prototype.draw=function(){var a=[{x:-0.9,y:-2},{x:0.9,y:-2},{x:0.9,y:2},{x:0,y:2.2},{x:-0.9,y:2},{x:-0.9,y:-2}],b=[{x:-0.12,y:-0.3},{x:0.12,y:-0.3},{x:0.12,y:0.3},{x:-0.12,y:0.3},{x:-0.12,y:-0.3}];this.engine.m_ctx_ex.set_trans(this.trans);this.engine.m_ctx_ex.m_trans.pos=Vec2.add(this.engine.m_ctx_ex.m_trans.pos,{x:0.3,y:-0.3});this.engine.m_ctx_ex.draw_poly(a,null,"rgba(0,0,0,0.1)");for(var c=0;c<this.wheels.length;++c)for(var e=0;e<this.wheels[c].length;++e){var d=this.wheels[c][e];this.engine.m_ctx_ex.set_trans(new Trans2({x:0,
y:0},0));this.engine.m_ctx_ex.m_ctx.lineWidth=0.24*this.engine.m_ctx_ex.m_zoom;this.engine.m_ctx_ex.m_ctx.lineJoin="bevel";for(var h=d.trail.length,i=!1,g=[],f=h-1;f>0&&f>h-this.trails_len;--f){var j=d.trail[f];j.w>1E3?(i=!0,g.push(j.p)):i&&(i=!1,this.engine.m_ctx_ex.draw_poly(g,"rgba(0,0,0,0.5)",null),g=[])}i&&this.engine.m_ctx_ex.draw_poly(g,"rgba(0,0,0,0.5)",null);this.engine.m_ctx_ex.m_ctx.lineWidth=1;this.engine.m_ctx_ex.set_trans(this.trans);h=Vec2.multiplyScalar(2.5E-4,d.old_force);this.engine.m_ctx_ex.draw_poly([d.pos,
Vec2.add(d.pos,h)],"#808080",null);this.engine.m_ctx_ex.set_trans(this.trans.TransFromT(new Trans2(d.pos,d.angle)));this.engine.m_ctx_ex.draw_circle({x:0,y:0},d.buget/4E3,"#808080",d.blocked?"rgba(0,0,0,0.2)":null);this.engine.m_ctx_ex.draw_poly(b,null,"#404040")}this.engine.m_ctx_ex.set_trans(this.trans);this.engine.m_ctx_ex.draw_poly(a,"#808080","rgba(255,255,255,0.8)");this.engine.m_ctx_ex.draw_poly([{x:0,y:1.2},{x:-0.8,y:1},{x:-0.8,y:0},{x:0.8,y:0},{x:0.8,y:1},{x:0,y:1.2},{x:0,y:2}],"#808080",
null);this.engine.m_ctx_ex.draw_poly([{x:-0.7,y:0},{x:-0.7,y:-1.9},{x:0.7,y:-1.9},{x:0.7,y:0}],"#808080",null);this.engine.m_ctx_ex.draw_poly([{x:0,y:0.7},{x:-0.7,y:0.6},{x:-0.7,y:0},{x:0.7,y:0},{x:0.7,y:0.6},{x:0,y:0.7}],"#808080",null)};
function Hover(){this.velocity=new Vec2(0,0);this.path=this.angular_vel=this.speed=0;this.trans=new Trans2(this.pos,this.angle,null);this.c_drag=1;this.c_turb=30;this.resistance=0.003;this.side_res=0.015;this.rotation=this.strafe_force=this.force=10;this.angular_res=0.5}Hover.prototype=new ControllableObject;
Hover.prototype.run=function(a){var b=Vec2.multiplyScalar(this.traction*this.force,this.trans.m_r.col2);b.AddV(Vec2.multiplyScalar(this.strafe*this.strafe_force,this.trans.m_r.col1));this.angular_vel+=(this.steering*this.rotation-this.angular_vel*this.angular_res*(this.speed+1))*a;var c=Vec2.dot(this.trans.m_r.col2,this.velocity),e=Vec2.dot(this.trans.m_r.col1,this.velocity),c=(Math.abs(c)*this.c_drag+this.c_turb)*c*this.resistance;b.AddV(Vec2.multiplyScalar(-c,this.trans.m_r.col2));e=(Math.abs(e)*
this.c_drag+this.c_turb)*e*this.side_res;b.AddV(Vec2.multiplyScalar(-e,this.trans.m_r.col1));this.velocity.AddV(Vec2.multiplyScalar(a,b));this.speed=this.velocity.Length();Debug.write_line("<br/>Speed: "+Math.round(this.speed*3.6)+"km/h");this.angle+=a*this.angular_vel;this.pos.AddV(Vec2.multiplyScalar(a,this.velocity));this.trans=new Trans2(this.pos,this.angle,null)};
Hover.prototype.draw=function(){var a=[{x:0,y:-2},{x:0.5,y:-1.9},{x:1.5,y:-2.2},{x:1.5,y:-1.5},{x:0.6,y:0},{x:0,y:2},{x:-0.6,y:0},{x:-1.5,y:-1.5},{x:-1.5,y:-2.2},{x:-0.5,y:-1.9},{x:0,y:-2}];this.engine.m_ctx_ex.set_trans(this.trans);this.engine.m_ctx_ex.m_trans.pos=Vec2.add(this.engine.m_ctx_ex.m_trans.pos,{x:0.3,y:-0.3});this.engine.m_ctx_ex.draw_poly(a,null,"rgba(0,0,0,0.5)");this.engine.m_ctx_ex.set_trans(this.trans);this.engine.m_ctx_ex.draw_poly(a,"#808080","white");this.engine.m_ctx_ex.draw_poly([{x:0.5,
y:-1.9},{x:0.6,y:0},{x:0,y:0.5},{x:-0.6,y:0},{x:-0.5,y:-1.9},{x:0,y:-2},{x:0,y:2}],"#808080",null)};function Mechmind(){this.velocity=new Vec2(0,0);this.path=this.speed=0;this.c_drag=1;this.c_turb=30;this.resistance=0.001;this.force=Phys.g*0.5}Mechmind.prototype=new ControllableObject;
Mechmind.prototype.run=function(a){var b=Math2.Clamp(this.strafe-this.steering,-1,1),b=new Vec2(b,this.traction);b.Normalize();b.MulS(this.force);var c=(this.velocity.Length()*this.c_drag+this.c_turb)*this.resistance;b.AddV(Vec2.multiplyScalar(-c,this.velocity));this.velocity.AddV(Vec2.multiplyScalar(a,b));this.speed=this.velocity.Length();Debug.write_line("<br/>Speed: "+Math.round(this.speed*3.6)+"km/h");this.pos.AddV(Vec2.multiplyScalar(a,this.velocity))};
Mechmind.prototype.draw=function(){this.engine.m_ctx_ex.m_trans.pos=Vec2.add(this.pos,{x:0.1,y:-0.1});this.engine.m_ctx_ex.draw_circle({x:0,y:0},0.25,null,"rgba(0,0,0,0.5)");this.engine.m_ctx_ex.m_trans.pos.SetV(this.pos);this.engine.m_ctx_ex.draw_circle({x:0,y:0},0.25,"#808080","white")};
function BaseApplication(){this.m_ctx_id="";this.m_canvas_elm=this.m_ctx=null;this.m_canvas_height=this.m_canvas_width=0;this.m_buf_ctx=this.m_canvas_buffer=null;this.m_last_tick=0;this.m_keys=[];this.m_double_buffering=!1}BaseApplication.prototype.pre_init=function(a){this.m_ctx_id=a;var b=this;window.onload=function(){b.init_int()};document.onkeydown=function(a){b.key_down(a)};document.onkeyup=function(a){b.key_up(a)}};
BaseApplication.prototype.init_int=function(){this.m_canvas_elm=document.getElementById(this.m_ctx_id);this.m_ctx=this.m_canvas_elm.getContext("2d");this.m_canvas_width=parseInt(this.m_canvas_elm.width);this.m_canvas_height=parseInt(this.m_canvas_elm.height);this.m_double_buffering?(this.m_canvas_buffer=document.createElement("canvas"),this.m_canvas_buffer.width=this.m_canvas_width,this.m_canvas_buffer.height=this.m_canvas_height,this.m_buf_ctx=this.m_canvas_buffer.getContext("2d")):this.m_buf_ctx=
this.m_ctx;this.m_ctx_ex=new ContextEx(this.m_buf_ctx,this.m_canvas_width,this.m_canvas_height);this.m_last_tick=(new Date).getTime();this.init();var a=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||null,b=this;a?(_step=function(){b.step();tickID=a(_step)},_step()):(_step=function(){b.step()},setInterval(_step,0))};
BaseApplication.prototype.get_key=function(a){if(window.event)return a.returnValue=!1,a.keyCode;else if(a.which)return a.preventDefault(),a.which};BaseApplication.prototype.key_down=function(a){this.m_keys[this.get_key(a)]=!0};BaseApplication.prototype.key_up=function(a){this.m_keys[this.get_key(a)]=!1};
BaseApplication.prototype.step=function(){var a=(new Date).getTime(),b=(a-this.m_last_tick)/1E3;if(isNaN(b)||b>0.1)b=0.1;this.m_last_tick=a;b>0?Debug.output("FPS: "+Math.floor(1/b)):Debug.output("FPS: inf");this.process_keys(b);this.run(b);this.m_ctx_ex.run(b);this.draw(b);this.m_double_buffering&&this.m_ctx.drawImage(this.m_canvas_buffer,0,0)};BaseApplication.prototype.init=function(){};BaseApplication.prototype.process_keys=function(){};BaseApplication.prototype.run=function(){};
BaseApplication.prototype.draw=function(){};function Application(a){this.car=new ArcadeCar;this.car.init(this,{x:0,y:0},0);this.pre_init(a)}Application.prototype=new BaseApplication;
Application.prototype.init=function(){var a=this;document.getElementById("chABS").onchange=function(){if(a.car.abs!==void 0)a.car.abs=this.checked};document.getElementById("chTCS").onchange=function(){if(a.car.tcs!==void 0)a.car.tcs=this.checked};document.getElementById("chSTEER").onchange=function(){if(a.car.steer_control!==void 0)a.car.steer_control=this.checked};document.getElementById("selDRIVE").onchange=function(){if(a.car.set_drive!==void 0)switch(this.value){case "RWD":a.car.set_drive(!1,
!0);break;case "FWD":a.car.set_drive(!0,!1);break;case "AWD":a.car.set_drive(!0,!0)}}};function drive_val(a,b,c){if(Math.abs(a-b)<c)return a;b+=(a-b>0?1:-1)*c;return Math2.Clamp(b,-1,1)}
Application.prototype.process_keys=function(a){this.car.hand_brake=!1;var b=0;if(this.m_keys[key_code.UP]||this.m_keys[key_code.W])b=1;if(this.m_keys[key_code.DOWN]||this.m_keys[key_code.S])b-=1;this.car.traction=drive_val(b,this.car.traction,a*2);b=0;this.m_keys[key_code.LEFT]&&(b=1);this.m_keys[key_code.RIGHT]&&(b-=1);this.car.steering=drive_val(b,this.car.steering,a*4);if(this.m_keys[key_code.SPACE])this.car.hand_brake=!0;b=0;this.m_keys[key_code.A]&&(b=-1);this.m_keys[key_code.D]&&(b+=1);this.car.strafe=
drive_val(b,this.car.strafe,a*4);a=null;if(this.m_keys[key_code["1"]])switch(a=new ArcadeCar,a.abs=document.getElementById("chABS").checked,a.tcs=document.getElementById("chTCS").checked,a.steer_control=document.getElementById("chSTEER").checked,document.getElementById("selDRIVE").value){case "RWD":a.set_drive(!1,!0);break;case "FWD":a.set_drive(!0,!1);break;case "AWD":a.set_drive(!0,!0)}this.m_keys[key_code["2"]]&&(a=new SimpleCar);this.m_keys[key_code["3"]]&&(a=new Hover);this.m_keys[key_code["4"]]&&
(a=new Mechmind);if(a!=null)a.init(this,this.car.pos,this.car.angle),this.car=a};Application.prototype.run=function(a){this.car.run(a);this.m_ctx_ex.m_camera.x=this.car.pos.x;this.m_ctx_ex.m_camera.y=this.car.pos.y;this.m_ctx_ex.m_camera.z=50+this.car.speed*this.car.speed*0.25};Application.prototype.draw=function(a){this.m_ctx_ex.draw_grid();this.car.draw(a)};new Application("canvas");
    </script>
  </head>
<body bgcolor='F0F0F0'>
  <div style="text-align:center;">
    <canvas id="canvas" width='1024' height='768'></canvas>
    <p>
  	  <select id="selDRIVE">
  	  	<option value="RWD" selected="selected">RWD</option>
  	  	<option value="FWD">FWD</option>
  	  	<option value="AWD">AWD</option>
  	  </select>
      <input type="checkbox" checked="checked" id="chABS" onChange="">ABS
      <input type="checkbox" checked="checked" id="chTCS" onChange="">TCS
      <input type="checkbox" checked="checked" id="chSTEER" onChange="">Steering control
    </p>
    <p id="debug"></p>
  </div>
</body>
</html>
